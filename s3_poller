#! /usr/bin/env ruby

require 'uber-s3'
require 'json'
require 'yaml'
require 'optparse'

# ARGV = [aws_access_key_id, aws_secret_access_key, build_list_directory]

Usage = "Usage: ./s3_poller AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY [BUILD_LIST_DIRECTORY]"

optparse = OptionParser.new do |opts|
  opts.banner = Usage
  opts.on('-h', '--help') do
    puts Usage + "\n\n"
    puts "Logs into Amazon S3 using the AWS credentials AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY,
and then outputs a JSON detailing the available chef client artifacts.  The JSON is placed in the
BUILD_LIST_DIRECTORY if one is specified or otherwise is placed in a directory specified by the app's
cookbook.\n\n"
    puts "Subcommands:"
    puts "  -h,  --help\t\tThis help\n\n"
    exit
  end
end
optparse.parse!

# Connect to S3
begin
  puts "Validating S3 Credentials..."
  S3 = UberS3.new({
                    :access_key => ARGV[0],
                    :secret_access_key => ARGV[1],
                    :bucket => 'opscode-full-stack',
                    :adapter => :net_http
                  })
  S3.exists?
rescue
  puts
  puts "[ERROR] Could not connect to Amazon S3 using access key id #{ARGV[0]} and secret access key #{ARGV[1]}\n\n"
  puts Usage + "\n\n"
  exit
end
# List the available artifacts 

Artifact_directories = ['/debian-6.0.1-i686',
                        '/debian-6.0.1-x86_64',
                        '/el-5.7-i686',
                        '/el-5.7-x86_64',
                        '/el-6.2-i686',
                        '/el-6.2-x86_64',
                        '/mac_os_x-10.6.8-x86_64',
                        '/mac_os_x-10.7.2-x86_64',
                        #'/solaris2-5.9-sparc',
                        '/solaris2-5.11-i86pc',
                        '/ubuntu-10.04-i686',
                        '/ubuntu-10.04-x86_64',
                        '/ubuntu-11.04-i686',
                        '/ubuntu-11.04-x86_64']

Artifacts = Hash.new {|h,k| h[k] = Hash.new(&h.default_proc) }

def get_artifacts(directories=Artifact_directories)
  directories.each do |dir|
    S3.objects(dir).each do |artifact|
      # get the useful information from the filename
      # s3 object doesn't provide a nice way to get this otherwise
      art = artifact.to_s
      name = art.split(/\//)[1][0..-3]
      platform = dir[1..-1].split("-")[0]
      extension = name[/\.[[:alpha:]]+\z/]
      if extension == ".gz"
        if platform == "mac_os_x"
          extension = ".tar.gz"
        else
          next
        end
      elsif extension == ".sh"
        next
      else
        if platform == "mac_os_x"
          next
        end
      end
      if art.include?("server")
        next
      end
      platform_version = dir.split("-")[1]
      arch = dir.split("-")[2]
      chef_version = name[/\d+\.\d+\.\d+-?\d?+/].chomp("-")
      base = "http://opscode-full-stack.s3.amazonaws.com/"
      file_dir = art.split("@key=\"")[1].chop.chop
      url = base + file_dir
      Artifacts[platform][platform_version][arch][chef_version] = url
    end
  end
end

get_artifacts

build_list_path = YAML.load_file("./config/config.yml")['production']['build_list']

path_in = "#{ARGV[2]}/build_list.json" if ARGV[2]

File.open(path_in || build_list_path, "w") do |f|
  f.puts JSON.pretty_generate(Artifacts)
end
